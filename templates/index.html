<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cardápio do Campus</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.1/css/dataTables.bootstrap5.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.1/js/dataTables.bootstrap5.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">

</head>

<body>
    <header class="text-center p-3 bg-light shadow-sm">
        <div class="container">
            <div class="row align-items-center">

                <!-- Logo -->
                <div class="col-12 col-md-3 text-md-start">
                    <a href="https://videira.ifc.edu.br/" class="text-decoration-none fw-bold">
                        <img src="{{ url_for('static', filename='img/logoif.png') }}" alt="Logo"
                            class="img-fluid img-top">
                    </a>
                </div>

                <!-- Título -->
                <div class="col-12 col-md-6">
                    <h1 class="">Cardápio do Refeitório</h1>
                </div>

                <!-- Navegação -->
                <div class="col-12 col-md-3 mt-2 mt-md-0">
                    <img src="{{ url_for('static', filename='img/logo-saborecia.png') }}" alt="Logo"
                        class="img-fluid img-top">
                </div>

            </div>
        </div>

        <hr class="w-100">

        <div class="container">
            <div class="row align-items-right">
                <nav>
                    <ul class="list-unstyled d-flex gap-3 m-0">
                        <a href="" class="text-decoration-none">
                            <li>Ver Cardápio</li>
                        </a>
                    </ul>
                </nav>
            </div>
        </div>
        </div>
    </header>

    <div class="container">
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <h5 class="mb-2 mb-md-0">Selecione o mês:</h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <select id="select-mes" class="form-select w-auto">
                            <option value="">Carregando...</option>
                        </select>
                        <button id="toggle-view-top" class="btn btn-outline-primary">Modo Mobile</button>
                    </div>
                </div>

                <!-- Tabela -->
                <div class="table-responsive" id="tabela-wrapper">
                    <table id="tabela-cardapio" class="table table-striped table-hover" style="width:100%">
                        <thead></thead>
                        <tbody></tbody>
                    </table>
                </div>

                <!-- Cards -->
                <div class="card-container" id="cards-wrapper">
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3 d-flex" id="cards-list">

                    </div>


                    <!-- Paginação cards -->
                    <div class="cards-pagination">
                        <button class="btn btn-outline-secondary" id="prev-card-page">Anterior</button>
                        <span id="card-page-info"></span>
                        <button class="btn btn-outline-secondary" id="next-card-page">Próximo</button>
                    </div>

                    <!-- Botão alternar view inferior -->
                    <div class="text-center mt-3">
                        <button id="toggle-view-bottom" class="btn btn-outline-primary">Ver como tabela</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-12 col-md-4">
                    <h5><a href="https://fsw-ifc.brdrive.net/" class="text-decoration-none fw-bold">Fábrica de
                            Software</a></h5>
                    <p>Transformando Ideias em Soluções</p>
                    <p>© Fábrica de Software - IFC Videira - 2025</p>
                    <ul class="list-unstyled d-flex gap-3 m-0">
                        <li>
                            <a href="https://www.instagram.com/fsw.ifcvideira/">
                                <i class="fa fa-instagram icon"></i>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/fabricaSoftwareVideira">
                                <i class="fa fa-github icon"></i>
                            </a>
                        </li>
                    </ul>


                </div>
                <div class="col-12 col-md-4">
                    <h5><a href="https://videira.ifc.edu.br/" class="text-decoration-none fw-bold">IFC Campus
                            Videira</a></h5>
                    <p>Rodovia SC 135, km 125 - Bairro Campo Experimental - CEP 89564-590 - Videira - SC</p>
                    <p>(49) 3533-4900</p>
                </div>
                <div class="col-12 col-md-4">
                    <h5>Sabor e Cia</h5>
                    <p>Cardápio elaborado por Luciana Castro Brum</p>
                    <ul class="list-unstyled d-flex gap-3 m-0">
                        <li>
                            <a href="https://www.instagram.com/sabor_e_cia_ifc/">
                                <i class="fa fa-instagram icon"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>


    <script>
        $(document).ready(function () {
            const tabela = $('#tabela-cardapio');
            const tabelaWrapper = $('#tabela-wrapper');
            const cardsWrapper = $('#cards-wrapper');
            const cardsList = $('#cards-list');
            let dataTable = null;
            let dadosAtuais = [];
            let viewCards = false;

            // ...dentro do $(document).ready(function() { ...)

            // Cards
            let currentCardPage = 1;
            const cardsPerPage = 5; // alterado de 6 para 5

            function renderCardsPage() {
                cardsList.empty();
                if (!dadosAtuais || dadosAtuais.length === 0) {
                    cardsList.append('<p class="text-center text-warning">Nenhum dado disponível</p>');
                    $('#card-page-info').text('');
                    return;
                }

                const totalPages = Math.ceil(dadosAtuais.length / cardsPerPage);
                const start = (currentCardPage - 1) * cardsPerPage;
                const end = start + cardsPerPage;
                const pageItems = dadosAtuais.slice(start, end);

                pageItems.forEach(item => {
                    const card = `
                    <div class="col">
                            <div class="card h-100 shadow-sm">
                                <div class="card-body">
                                    <h6 class="card-title">${item.Data || ''}</h5>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item"><strong>Salada 1:</strong> ${item["Salada 1"] || '-'}</li>
                                        <li class="list-group-item"><strong>Salada 2:</strong> ${item["Salada 2"] || '-'}</li>
                                        <li class="list-group-item"><strong>Acompanhamento 1:</strong> ${item["Acompanhamento 1"] || '-'}</li>
                                        <li class="list-group-item"><strong>Acompanhamento 2:</strong> ${item["Acompanhamento 2"] || '-'}</li>
                                        <li class="list-group-item"><strong>Guarnição:</strong> ${item["Guarnição"] || '-'}</li>
                                        <li class="list-group-item"><strong>Prato Principal:</strong> ${item["Prato Principal"] || '-'}</li>
                                        <li class="list-group-item"><strong>Vegetariano:</strong> ${item["Vegetariano"] || '-'}</li>
                                    </ul>

                                </div>
                            </div>
                        </div>`;
                    cardsList.append(card);
                });

                $('#card-page-info').text(`Página ${currentCardPage} de ${totalPages}`);
            }

            $('#prev-card-page').click(() => {
                if (currentCardPage > 1) {
                    currentCardPage--;
                    renderCardsPage();
                }
            });

            $('#next-card-page').click(() => {
                const totalPages = Math.ceil(dadosAtuais.length / cardsPerPage);
                if (currentCardPage < totalPages) {
                    currentCardPage++;
                    renderCardsPage();
                }
            });

            function toggleViewCards(show) {
                viewCards = show;
                if (viewCards) {
                    tabelaWrapper.hide();
                    cardsWrapper.show();
                    renderCardsPage();
                    $('#toggle-view-top, #toggle-view-bottom').text('Ver como tabela');
                } else {
                    cardsWrapper.hide();
                    tabelaWrapper.show();
                    $('#toggle-view-top, #toggle-view-bottom').text('Modo Mobile');
                }
            }

            $('#toggle-view-top, #toggle-view-bottom').click(() => toggleViewCards(!viewCards));

            function carregarTabela(mes) {
                if (!mes) return;

                tabela.find('tbody').html('<tr><td colspan="10" class="text-center">' +
                    '<div class="spinner-border text-primary" role="status">' +
                    '<span class="visually-hidden">Carregando...</span></div></td></tr>');

                fetch(`/api/cardapio/${mes}`)
                    .then(response => {
                        if (!response.ok) throw new Error('Erro na resposta da API');
                        return response.json();
                    })
                    .then(dados => {
                        if (dados.erro) { alert('Erro: ' + dados.erro); return; }

                        dadosAtuais = dados;
                        currentCardPage = 1;

                        const colunas = ["Data", "Salada 1", "Salada 2", "Acompanhamento 1", "Acompanhamento 2", "Guarnição", "Prato Principal", "Vegetariano"];

                        if (dataTable) {
                            dataTable.destroy();
                            tabela.empty();
                            tabela.append('<thead class="table-dark"></thead><tbody></tbody>');
                        }

                        dataTable = tabela.DataTable({
                            data: dados,
                            columns: colunas.map(key => {
                                if (key === "Data") {
                                    return {
                                        title: key,
                                        data: key,
                                        render: function (data, type) {
                                            if (type === 'sort' && data) {
                                                try {
                                                    const partes = data.split(',');
                                                    if (partes.length > 1) {
                                                        const dataParte = partes[1].trim();
                                                        const [dia, , mesTexto, , ano] = dataParte.split(' ');
                                                        const meses = {
                                                            janeiro: '01', fevereiro: '02', março: '03', abril: '04',
                                                            maio: '05', junho: '06', julho: '07', agosto: '08',
                                                            setembro: '09', outubro: '10', novembro: '11', dezembro: '12'
                                                        };
                                                        const mesNum = meses[mesTexto.toLowerCase()];
                                                        if (mesNum) return `${ano}/${mesNum}/${dia.padStart(2, '0')}`;
                                                    }
                                                } catch (e) { console.error('Erro ao processar data:', e, data); }
                                            }
                                            return data || '';
                                        }
                                    };
                                }
                                return { title: key, data: key, render: data => data || '' };
                            }),
                            order: [[0, 'asc']],
                            responsive: true,
                            language: { url: '//cdn.datatables.net/plug-ins/1.13.1/i18n/pt-BR.json', emptyTable: "Nenhum dado disponível" },
                            pageLength: 5, // alterado para 5
                            lengthMenu: [5, 10, 25], // alterado para 5, 10 e 25
                            destroy: true
                        });

                        if (viewCards) renderCardsPage();
                    })
                    .catch(error => {
                        console.error('Erro:', error);
                        tabela.find('tbody').html('<tr><td colspan="10" class="text-center text-danger">Falha ao carregar o cardápio.</td></tr>');
                    });
            }

            fetch('/api/meses')
                .then(res => res.ok ? res.json() : Promise.reject('Erro ao carregar meses'))
                .then(meses => {
                    const select = $('#select-mes');
                    select.empty();
                    if (meses && meses.length > 0) {
                        select.append('<option value="">Selecione um mês</option>');
                        meses.forEach(m => select.append(`<option value="${m.id}">${m.nome}</option>`));
                        select.val(meses[0].id);
                        carregarTabela(meses[0].id);
                        select.on('change', function () { carregarTabela(this.value); });
                    } else {
                        select.html('<option value="">Nenhum mês disponível</option>');
                        tabela.find('tbody').html('<tr><td colspan="10" class="text-center text-warning">Nenhum mês disponível na planilha</td></tr>');
                    }
                })
                .catch(error => {
                    console.error('Erro ao carregar meses:', error);
                    $('#select-mes').html('<option value="">Erro ao carregar meses</option>');
                    tabela.find('tbody').html('<tr><td colspan="10" class="text-center text-danger">Erro ao carregar lista de meses: ' + error + '</td></tr>');
                });
        });
    </script>
</body>

</html>